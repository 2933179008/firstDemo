<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tbl.modules.external.dao.ErpInterfaceServiceDAO">
    <!--更新入库表erp_flag字段-->
    <update id="updateInstorageBillErpFlag">
        <foreach collection="list" item="instorage" index="index" separator=";" open="" close="">
            update instorage_bill set erp_flag='1'
            where id=#{instorage.id}
        </foreach>
    </update>

    <!--查询满足调用采购入库单接口条件的入库单-->
    <select id="selectConfessInstorageBill" resultType="java.util.Map">
        select a.*
        from instorage_bill a
        inner join quality_bill b on a.id=b.instorage_bill_id
        where a.instorage_type='0'
        and a.state='3'
        and b.state='1'
        and a.erp_flag='0'
    </select>

    <!--查询满足调用采购入库单接口条件的入库单  越库类型-->
    <select id="selectCrossInstorageBill" resultType="java.util.Map">
        select * from instorage_bill where instorage_type='0' and cross_docking='1' and state='3' and erp_flag='0'
    </select>

    <!--根据入库单id查询上架单详情-->
    <select id="selectPutBillDetail" resultType="java.util.Map">
        select b.*
        from put_bill a inner join put_bill_detail b on a.id=b.put_bill_id
        where a.instorage_bill_id=#{instorageBillId}
    </select>

    <!--查询满足调用委托加工入库单接口条件的入库单-->
    <select id="selectEntrustInstorageBill" resultType="java.util.Map">
        select a.*
        from instorage_bill a
        inner join quality_bill b on a.id=b.instorage_bill_id
        where a.instorage_type='1'
        and a.state='3'
        and b.state='1'
        and a.erp_flag='0'
    </select>

    <!--查询满足调用委托加工入库单接口条件的入库单  越库类型-->
    <select id="selectCrossEntrustInstorageBill" resultType="java.util.Map">
       select * from instorage_bill where instorage_type='1' and cross_docking='1' and state='3' and erp_flag='0'
    </select>

    <!--查询满足调用生产退货入库单(自采料)接口条件的入库单-->
    <select id="selectConfessReturnInstorageBill" resultType="java.util.Map">
        select a.*,c.outstorage_bill_code,c.spare_bill_code,a.customer_code
        from instorage_bill a
        inner join quality_bill b on a.id=b.instorage_bill_id
        inner join outstorage_bill c on a.outstorage_bill_id=c.id
        where a.instorage_type='2'
        and a.state='3'
        and b.state='1'
        and c.outstorage_bill_type='0'
        and c.material_type=#{materialType}
        and a.erp_flag='0'
    </select>

</mapper>