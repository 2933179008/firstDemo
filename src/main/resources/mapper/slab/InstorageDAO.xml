<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tbl.modules.slab.dao.InstorageSlabDAO">
    <insert id="insertSlabBillBunding">
        insert into slab_bill_bunding(user_id,user_ip,put_bill_id,create_time,update_time)
        values(#{userId},#{userIP},#{putBillId},now(),now())
    </insert>
    <!--插入叉车正在操作单据的类型表-->
    <insert id="insertSlabOperateType">
        insert into slab_operate_type(user_ip,operate_type,create_time,update_time)
        values(#{userIP},'1',now(),now())
    </insert>
    <update id="updateSlabBillBunding">
        update slab_bill_bunding
          set user_id=#{userId},
          put_bill_id=#{putBillId},
          rfid=null,
          position_code=null,
          alert_key=null,
          alert_value=null,
          update_time=now()
        where user_ip=#{userIP}
    </update>
    <!--更新上架单表状态为“待上架”-->
    <update id="updatePutBillState">
        update put_bill set state='1',operator=#{userId},operator_name=#{userName} where id=#{putBillId}
    </update>
    <!--更新平板参数绑定表的rfid和验证字段-->
    <update id="updateSlabBillBundingRfid">
        update slab_bill_bunding set rfid=#{slabRfid},alert_key=#{alertKey},alert_value=#{alertValue}
        where user_ip=#{userIP}
    </update>
    <update id="updateSlabBillBundingPositionCode">
        update slab_bill_bunding set position_code=#{positionCode}
        where user_ip=#{userIP}
    </update>
    <!--更新叉车正在操作单据的类型表-->
    <update id="updateSlabOperateType">
        update slab_operate_type set operate_type='1',update_time=now()
        where user_ip=#{userIP}
    </update>
    <!--更新平板入库操作参数绑定关系表的字段-->
    <update id="updateAlert1">
        update slab_bill_bunding set rfid=null,alert_key=null,alert_value=null,position_code=null
        where user_ip=#{userIP}
    </update>
    <update id="updateAlert2">
        update slab_bill_bunding set alert_key='2',alert_value='rfid已锁定'
        where user_ip=#{userIP}
    </update>
    <!--更新slab_bill_bunding表的alert_key字段为3（已确定库位）-->
    <update id="updateAlertToUp">
        update slab_bill_bunding set alert_key='3',alert_value='已确定库位'
        where user_ip=#{userIP}
    </update>
    <!--根据用户id和ip查询平板绑定关系表中是否存在数据-->
    <select id="selectCountByUserIDAndIp" resultType="java.lang.Integer">
        select count(1)
        from slab_bill_bunding
        where user_ip=#{userIP}
    </select>
    <!--获取上架单列表-->
    <select id="getPagePutBillList" resultType="com.tbl.modules.instorage.entity.PutBill">
        select a.*
        from put_bill a
        left join instorage_bill b on a.instorage_bill_id=b.id
        where 1=1
        and (a.operator=#{userId} or a.operator is null)
        and a.state in('0','1','2')
        and b.instorage_process='0'
    </select>
    <select id="getSlabBillBunding" resultType="java.util.Map">
        select * from slab_bill_bunding where user_ip=#{userIP}
    </select>
    <!--根据rfid查询绑定的物料-->
    <select id="getMaterialBundingDetail" resultType="java.util.Map">
        select a.*
        from materiel_bind_rfid_detail a
        inner join materiel_bind_rfid b on a.materiel_bind_rfid_by=b.id
        where b.rfid=#{rfid}
        and b.deleted_flag='1'
        and a.delete_flag='1'
    </select>
    <!--根据上架单id和物料编号获取上架单对应的入库详情单-->
    <select id="getPutBillDetailMap" resultType="java.util.Map">
        select a.*
        from instorage_bill_detail a
        inner join instorage_bill b on a.instorage_bill_id=b.id
        inner join put_bill c on b.id=c.instorage_bill_id
        where c.id=#{putBillId}
        and a.material_code=#{materialCode}
    </select>
    <!--获取库位下拉框列表-->
    <select id="getSelectPositionList" resultType="java.util.Map">
        select position_code as id,position_name as text
        from base_depot_position
        JOIN base_depot_area on (base_depot_area.id = base_depot_position.depotarea_id)
        where depotarea_id IN (#{areaId}) and
        (start_x <![CDATA[ >= ]]> #{x_Size} and start_x <![CDATA[ <= ]]> #{xSize}) and
        (start_y <![CDATA[ >= ]]> #{y_Size} and start_y <![CDATA[ <= ]]> #{ySize})
        <if test='queryString!=null and queryString!=""'>
            and position_name like concat(concat('%', #{queryString}), '%')
        </if>
        order by position_code
    </select>
    <!--获取库位下拉框列表总条数-->
    <select id="getSelectPositionTotal" resultType="java.lang.Integer">
        select count(1)
        from base_depot_position
        JOIN base_depot_area on (base_depot_area.id = base_depot_position.depotarea_id)
        where depotarea_id IN (#{areaId})  and
        (start_x <![CDATA[ >= ]]> #{x_Size} and start_x <![CDATA[ <= ]]> #{xSize}) and
        (start_y <![CDATA[ >= ]]> #{y_Size} and start_y <![CDATA[ <= ]]> #{ySize})
        <if test='queryString!=null and queryString!=""'>
            and position_name like concat(concat('%', #{queryString}), '%')
        </if>
    </select>
    <!--根据ip查询叉车正在操作单据的类型表中是否存在数据-->
    <select id="selectOperateTypeCount" resultType="java.lang.Integer">
        select count(1)
        from slab_operate_type
        where user_ip=#{userIP}
    </select>
    <!--根据库位编号查询该库位上已存放的物料的托盘库存数量总数和库存重量总数-->
    <select id="getStockBypositionCode" resultType="java.util.Map">
        select
--         sum(stock_weight) totalStockWeight,
        sum(stock_rfid_amount) totalStockRfidAmount
        from stock
        where position_code = #{positionCode}
        and material_type = '1'
        group by position_code
    </select>
    <!--查询推荐的新的库位-->
    <select id="selectRecommendPosition" resultType="java.util.Map">
        select position_code
        from base_depot_position
        where 1=1
        <if test="lstpositionCode != null and lstpositionCode.size>0">
            and position_code not in
            <foreach collection="lstpositionCode" item="positionCode" index="index" open="(" separator="," close=")">
                #{positionCode}
            </foreach>
        </if>
        <if test="lstAvailableClassify != null and lstAvailableClassify.size>0">
            and classify in
            <foreach collection="lstAvailableClassify" item="availableClassify" index="index" open="(" separator=","
                     close=")">
                #{availableClassify}
            </foreach>
        </if>
        and capacity_weight >= #{weight}
        order by position_code
        limit 1
    </select>
    <!--查询推荐的新的库位2-->
    <select id="selectRecommendPosition2" resultType="java.util.Map">
        select position_code
        from base_depot_position
        where depotarea_id = #{areaId}
        <if test="lstpositionCode != null and lstpositionCode.size>0">
            and position_code not in
            <foreach collection="lstpositionCode" item="positionCode" index="index" open="(" separator="," close=")">
                #{positionCode}
            </foreach>
        </if>
        and position_frozen = '0'
        order by id
        limit 1
        <!--<if test="lstAvailableClassify != null and lstAvailableClassify.size>0">-->
            <!--and classify in-->
            <!--<foreach collection="lstAvailableClassify" item="availableClassify" index="index" open="(" separator=","-->
                     <!--close=")">-->
                <!--#{availableClassify}-->
            <!--</foreach>-->
        <!--</if>-->
        <!--and capacity_weight >= #{totalMaterialWeight}-->
--         and blend_type = '0'
    </select>
    <!--根据入库单id和物料编号获取入库单详情中的批次号-->
    <select id="getInstorageBillBatchNo" resultType="java.lang.String">
        select batch_no
        from instorage_bill_detail
        where instorage_bill_id=#{instorageBillId}
        and material_code=#{materialCode}
    </select>

    <select id="getExecuteRfid" resultType="java.util.Map">
        select rfid from slab_bill_bunding
        where user_ip=#{userIP}
        and alert_key='1'
    </select>
    <!--获取小车位置-->
    <select id="getCarPosition" resultType="com.tbl.modules.visualization.entity.StockCar">
        select umr.tag,xsize,ysize,create_time,is_move,scene_code,forklift_name,user_ip
        from  uwb_move_record as umr
        JOIN uwb_forklift as uf on (umr.tag = uf.tag)
        where uf.tag = #{forkliftTag}
        and scene_code = #{areaCode}
        and create_time between #{formDate} and #{nowDate}
    </select>

    <!--查询上架单对应的入库单的入库流程（0：一般流程；1：白糖流程）-->
    <select id="getInstorageProcess" resultType="java.lang.String">
        select a.instorage_process
        from instorage_bill a
        inner join put_bill b on a.id=b.instorage_bill_id
        where b.id=#{putBillId}
    </select>
    <!--查询rfid是否已存在-->
    <select id="getExistRfidCount" resultType="java.lang.Long">
        select id
        from materiel_bind_rfid
        where rfid = #{rfid}
        and deleted_flag = '1'
        and status = '0'
    </select>

    <select id="getForkliftSelected" resultType="java.lang.String">
        select tag
        from uwb_forklift where user_ip = #{userIp}
    </select>
    <select id="getUwbMoveRecord" resultType="com.tbl.modules.noah.entity.UwbMoveRecord">
        SELECT xsize,ysize FROM `uwb_move_record` AS umr
        JOIN uwb_forklift uf ON umr.tag = uf.tag
        WHERE uf.user_ip = #{userIp}
    </select>
</mapper>