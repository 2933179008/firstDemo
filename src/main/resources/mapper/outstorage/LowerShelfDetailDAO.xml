<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tbl.modules.outstorage.dao.LowerShelfDetailDAO">
    <!-- 通过ID删除库存数据 -->
    <delete id="deleteStockById">
        delete from stock where id = #{id}
    </delete>

    <!--通过出库单ID删除对应的下架单的详情 -->
    <select id="deleteLowerShelDetail" resultType="java.lang.Object">
        delete from lower_shelf_bill_detail where lower_shelf_bill_id in(select id from lower_shelf_bill where outstorage_bill_id = #{outStorageId})
    </select>

    <!--通过下架单详情Id更新对应的下架单的Id -->
    <select id="updateLowerDetail" resultType="java.lang.Integer">
        update lower_shelf_bill_detail set state = 2 where id = #{lowerDetailId}
    </select>

    <!--通过下架单详情Id获取对应的出库单的Id -->
    <select id="getOutStorageId" resultType="java.lang.Object">
        select outstorage_bill_id from lower_shelf_bill where id =(select lower_shelf_bill_id from lower_shelf_bill_detail where id = #{lowerDetailId})
    </select>

    <!--更新物料绑定表中的锁定情况 -->
    <select id="updateMaterialBind" resultType="java.lang.Integer">
        update materiel_bind_rfid_detail
        set amount = amount-#{amount},occupy_stock_amount=0,outstorage_bill_code=''
        ,weight= weight-#{weight},occupy_stock_weight=0
        where batch_rule = #{batchNo} and materiel_code =#{materialCode} and rfid = #{rfid}
    </select>

    <!--更新库存表中的锁定情况 -->
    <select id="updateStockAmount" resultType="java.lang.Integer">
        update stock set  stock_amount=stock_amount-#{amount}
        ,available_stock_amount = available_stock_amount-#{amount}
        ,stock_weight=stock_weight-#{weight}
        ,available_stock_weight=available_stock_weight-#{weight}
        ,occupy_stock_amount=occupy_stock_amount-#{amount}
        ,occupy_stock_weight=occupy_stock_weight-#{weight}
        ,outstorage_bill_code=replace(outstorage_bill_code,#{outcode},'')
        where batch_no = #{batchNo} and material_code =#{materialCode}
        and material_type= #{type}
        <if test="type == 1">
            and rfid like concat(concat('%', #{rfid}), '%')
        </if>
    </select>

    <!--出库单 更新库存表中的锁定情况 -->
    <select id="updateStockAmountOutStorageBill" resultType="java.lang.Integer">
        update stock set  stock_amount=stock_amount-#{amount}
        ,stock_weight=stock_weight-#{weight}
        ,occupy_stock_amount=occupy_stock_amount-#{amount}
        ,occupy_stock_weight=occupy_stock_weight-#{weight}
        ,outstorage_bill_code=replace(outstorage_bill_code,#{outcode},'') where batch_no = #{batchNo} and material_code =#{materialCode}
        and material_type= #{type}
        <if test="type == 1">
            and rfid like concat(concat('%', #{rfid}), '%')
        </if>
    </select>

    <!--查询对应的下架单是否全部完成 -->
    <select id="lowerCount" resultType="java.lang.Integer">
        select count(1) from lower_shelf_bill_detail where lower_shelf_bill_id = (select lower_shelf_bill_id from lower_shelf_bill_detail where id = #{lowerDetailId}) and state != 2
    </select>

    <!--更新下架状态为正在执行中 -->
    <select id="updateLowerShelfState" resultType="java.lang.Integer">
        update lower_shelf_bill set state = #{state} where id = (select lower_shelf_bill_id from lower_shelf_bill_detail where id = #{id})
    </select>

    <!--通过下架单的ID获取对应的下架的详情 -->
    <select id="lowerInterfaceDetailList" resultType="java.util.Map">
        select id,material_code,material_name,batch_no,amount,weight,state,position_code,rfid from lower_shelf_bill_detail  where state !=2 and lower_shelf_bill_id = #{lowerId}
    </select>

    <!--通过出库单ID获取对应的出库单的类型 -->
    <select id="getOutStorageType" resultType="java.lang.Object">
        select outstorage_bill_type from outstorage_bill where id = #{outStorageId}
    </select>

    <!--通过rfid 删除物料绑定表中的库存 -->
    <select id="deleteMaterialBind" resultType="java.lang.Boolean">
        delete  from materiel_bind_rfid_detail where rfid = #{rfid} and batch_rule = #{batchNo} and materiel_code = #{materialCode}
    </select>

    <!--通过rfid 获取库存中的部分数值 -->
    <select id="getStockMap" resultType="java.util.Map">
        select id,stock_amount,available_stock_rfid_amount,rfid,available_rfid,rfid,outstorage_bill_code from stock
        where batch_no = #{batchNo} and material_code = #{materialCode} and material_type = #{type}
        <if test="type == 1">
           and rfid like concat(concat('%', #{rfid}), '%')
        </if>
    </select>

    <!--通过rfid 获取库存中的部分数值 -->
    <select id="getTransform" resultType="java.lang.Object">
        select transform from lower_shelf_bill_detail where id = #{id}
    </select>

    <!--跟新库存绑定表中的数值 -->
    <select id="updateTransformStock" resultType="java.lang.Void">
        update stock set available_stock_amount = available_stock_amount+#{amount},available_stock_weight+#{weight} where batch_no = #{batchNo} and outstorage_bill_code = #{outStorageId} and material_type = #{type}
        <if test="type == 1">
            and available_rfid like concat(concat('%', #{rfid}), '%')
        </if>
    </select>


    <select id="updateTransformAmount" resultType="java.lang.Void">
        update stock set available_stock_amount = available_stock_amount-#{amount},available_stock_weight-#{weight} where material_source = (select id from stock where  available_rfid like concat(concat('%', #{rfid}), '%') and  batch_no = #{batchNo} and outstorage_bill_code = #{outStorageId}) and materiel_power = 1 and material_type = #{type}
    </select>



    <!--通过rfid 删除库存中的部分数据 -->
    <select id="deleteStockRfid" resultType="java.lang.Boolean">
        delete from stock where batch_no = #{batchNo} and material_code = #{materialCode}
        <if test="type == 1">
            and rfid like concat(concat('%', #{rfid}), '%')
        </if>
    </select>

    <!--通过rfid 将库存中绑定rfid 进行删除 -->
    <select id="updateStockRfid" resultType="java.lang.Boolean">
        update stock set available_rfid = #{trueRfid},rfid =#{stockdRfid},available_stock_rfid_amount = available_stock_rfid_amount -1,stock_rfid_amount = stock_rfid_amount -1
        where batch_no = #{batchNo} and material_code = #{materialCode} and material_type = #{type}
        <if test="type == 1">
            and rfid like concat(concat('%', #{rfid}), '%')
        </if>
    </select>

    <!--通过rfid 获取对应的出库单的操作人 -->
    <select id="getLowerUserId" resultType="java.lang.Object">
        select user_id from lower_shelf_bill where state in(1,3) and id in(select lower_shelf_bill_id from lower_shelf_bill_detail where rfid = #{rfid} and state !=2)
    </select>

    <!--通过id获取对应的任务的信息 -->
    <select id="lowerDetail" resultType="java.util.Map">
        select id,weight,amount,material_code from lower_shelf_bill_detail where id = #{lowerDetailId} and state !=2
    </select>

    <!--通过rfid获取对应的任务的信息 -->
    <select id="getSpareBillId" resultType="java.lang.Object">
        select spare_bill_code from outstorage_bill where id = #{outStorageId}
    </select>


    <!--通过rfid获取对应的任务的信息 -->
    <select id="deleteLowerDetail" resultType="java.lang.Object">
        delete from lower_shelf_bill_detail where lower_shelf_bill_id = #{lowerId}
    </select>


    <!--通过出库单的Id获取对应的下架单的详情的数据 -->
    <select id="getDetailList" resultType="java.util.Map">
        select * from lower_shelf_bill_detail where lower_shelf_bill_id = (select id from lower_shelf_bill where outstorage_bill_id = #{outstorageId})
    </select>


    <select id = "updateState" resultType="java.lang.Object">
        update spare_bill set state = 4 where spare_bill_code = #{spareBillId}
    </select>

</mapper>