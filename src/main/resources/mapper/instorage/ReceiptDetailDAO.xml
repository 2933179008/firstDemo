<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tbl.modules.instorage.dao.ReceiptDetailDAO">
    <!--入库单详情插入数据-->
    <insert id="insertInstorageDetail">
        insert into instorage_bill_detail(instorage_bill_id,material_code,material_name,batch_no,unit,instorage_amount,separable_amount,instorage_weight,separable_weight,product_date)
        select #{detail.instorageBillId},material_code,material_name,#{detail.batchNo},unit,#{detail.inStorageAmount},#{detail.inStorageAmount},#{detail.inStorageWeight},#{detail.inStorageWeight},#{detail.productDate}
        from receipt_plan_detail
        where id=#{detail.receiptPlanDetailId}
    </insert>

    <!--更新收货单详情的计划收货数量，并且更新可拆分数量-->
    <update id="updatePlanReceiptAmount">
        update receipt_plan_detail set plan_receipt_amount=#{planReceiptAmount},separable_amount=#{planReceiptAmount}
        where id = #{receiptDetailId}
    </update>
    <!--更新收货单详情的批次号-->
    <update id="updateBatchNo">
        update receipt_plan_detail set batch_no=#{batchNo}
        where id = #{receiptDetailId}
    </update>
    <!--更新收货单详情的计划收货重量，并且更新可拆分重量-->
    <update id="updatePlanReceiptWeight">
        update receipt_plan_detail set plan_receipt_weight=#{planReceiptWeight},separable_weight=#{planReceiptWeight}
        where id = #{receiptDetailId}
    </update>
    <!--根据收货单详情id更新可拆分数量和可拆分重量-->
    <update id="updateSeparableAmountAndWeight">
        update receipt_plan_detail set separable_amount=separable_amount-#{detail.inStorageAmount},separable_weight=separable_weight-#{detail.inStorageWeight}
        where id=#{detail.receiptPlanDetailId}
    </update>

    <!--获取物料下拉列表-->
    <select id="getSelectMaterialList" resultType="java.util.Map">
        select materiel_code as id,materiel_name as text from base_materiel where 1=1 and deleted_flag=1
        <if test='queryString!=null and queryString!=""'>
            and materiel_name like concat(concat('%', #{queryString}), '%')
        </if>
    </select>

    <!--获取物料下拉列表总条数-->
    <select id="getSelectMaterialTotal" resultType="java.lang.Integer">
        select count(1) from base_materiel where 1=1 and deleted_flag=1
        <if test='queryString!=null and queryString!=""'>
            and materiel_name like concat(concat('%', #{queryString}), '%')
        </if>
    </select>

    <!--根据收货单主键和物料编码获取物料数量-->
    <select id="getMaterialCount" resultType="java.lang.Integer">
        select count(1) from receipt_plan_detail
        where receipt_plan_id = #{receiptId} and material_code in
        <foreach collection="materialCodes" item="materialCode" index="index" open="(" separator="," close=")">
            #{materialCode}
        </foreach>
    </select>

    <!--update by anss 2019-04-22 start-->
    <!--根据当前日期获取最大编号-->
    <!--<select id="getMaxBatchNoCode" resultType="java.lang.String">
        select max(SUBSTR(batch_no,length(batch_no)-3))
        from instorage_bill_detail
        where SUBSTR(batch_no,length(batch_no)-11,8)=#{nowDate}
    </select>-->

    <select id="getMaxBatchNoCode" resultType="java.lang.String">
        SELECT IF(MAX(SUBSTR(batch_no,25)) IS NULL,1,MAX(CAST(SUBSTR(batch_no,25) AS SIGNED)) + 1) AS batchNo
        FROM instorage_bill_detail
        WHERE batch_no like concat(concat('%', #{bathNoRule}), '%')
    </select>

    <!--update by anss 2019-04-22 end-->


    <update id="updatePlanReceiptAmountAndWeight">
        update receipt_plan_detail set plan_receipt_amount=#{planReceiptAmount},separable_amount=#{planReceiptAmount}
        where id = #{receiptDetailId}
    </update>
</mapper>