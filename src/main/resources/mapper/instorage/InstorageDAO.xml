<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tbl.modules.instorage.dao.InstorageDAO">
    <!--根据入库单id更新状态-->
    <update id="updateState">
        update instorage_bill set state = #{state} where id=#{instorageId}
    </update>
    <!--更新收货单详情的可拆分数量和可拆分重量-->
    <update id="updateReceiptSeparableAmountAndWeight">
        <foreach collection="lstInstorageDetail" item="instorageDetail" index="index" separator=";" open="" close="">
            update receipt_plan_detail
            set separable_amount=separable_amount+#{instorageDetail.instorageAmount},separable_weight=separable_weight+#{instorageDetail.instorageWeight}
            where receipt_plan_id = #{receiptPlanId}
            and material_code = #{instorageDetail.materialCode}
        </foreach>
    </update>
    <!--更新出库单详情中物料的可拆分数量和重量-->
    <update id="updateOutstorageBillDetail">
        <foreach collection="lstInstorageDetail" item="instorageDetail" index="index" separator=";" open="" close="">
            update outstorage_bill_detail
            set separable_amount=separable_amount-#{instorageDetail.instorageAmount},separable_weight=separable_weight-#{instorageDetail.instorageWeight}
            where outstorage_bill_id=#{outstorageBillId}
            and material_code=#{instorageDetail.materialCode}
            and batch_no=#{instorageDetail.batchNo}
        </foreach>
    </update>
    <!--更新入库单详情的可拆分数量和重量-->
    <update id="updateDetailSeparableAmountAndWeight">
        update instorage_bill_detail
            set separable_amount=instorage_amount,
                separable_weight=instorage_weight
            where instorage_bill_id=#{instorageId}
    </update>
    <!--获取最大入库单编号-->
    <select id="getMaxInstorageCode" resultType="java.lang.String">
        select max(instorage_bill_code) from instorage_bill
    </select>

    <!--获取入库单列表-->
    <select id="getPageInstorageList" resultType="com.tbl.modules.instorage.entity.Instorage">
        select a.*,b.receipt_code receiptCode,c.username userName
        from instorage_bill a
        left join receipt_plan b on a.receipt_plan_id=b.id
        left join sys_user c on a.create_by=c.user_id
        where 1=1
        <if test="instorageBillCode != null and instorageBillCode!=''">
            and a.instorage_bill_code like concat(concat('%', #{instorageBillCode}), '%')

        </if>
        <if test="instorageType != null and instorageType!=''">
            and a.instorage_type = #{instorageType}
        </if>
        <if test="userName != null and userName!=''">
            and c.username like concat(concat('%', #{userName}), '%')
        </if>
        <if test="createTime != null and createTime!=''">
            and a.create_time like concat(concat('%', #{createTime}), '%')
        </if>
    </select>
    <!--获取出库单下拉列表-->
    <select id="getSelectOutstorageBillList" resultType="java.util.Map">
        select id,outstorage_bill_code as text
        from outstorage_bill
        where 1=1
        and state='5'
        and outstorage_bill_type='0'
        <if test='queryString!=null and queryString!=""'>
            and materiel_name like concat(concat('%', #{queryString}), '%')
        </if>
    </select>
    <!--获取收货单下拉列表-->
    <select id="getSelectReceiptPlanList" resultType="java.util.Map">
        select id,receipt_code as text
        from receipt_plan
        where 1=1
        and state!='0'
        <if test='queryString!=null and queryString!=""'>
            and receipt_code like concat(concat('%', #{queryString}), '%')
        </if>
    </select>
    <!--获取出库单下拉列表数据总条数-->
    <select id="getSelectOutstorageBillTotal" resultType="java.lang.Integer">
        select count(1)
        from outstorage_bill
        where 1=1
        and state='5'
        and outstorage_bill_type='0'
        <if test='queryString!=null and queryString!=""'>
            and materiel_name like concat(concat('%', #{queryString}), '%')
        </if>
    </select>
    <!--根据出库单id查询生产任务单号-->
    <select id="getProductNo" resultType="java.lang.String">
        select a.product_no
        from spare_bill a
        inner join outstorage_bill b on a.spare_bill_code=b.spare_bill_code
        and b.id=#{outstorageBillId}
    </select>
    <!--根据id获取入库单导出列-->
    <select id="getAllLists" resultType="com.tbl.modules.instorage.entity.Instorage">
        select a.*,b.receipt_code receiptCode,c.username userName
        from instorage_bill a
        left join receipt_plan b on a.receipt_plan_id=b.id
        left join sys_user c on a.create_by=c.user_id
        where 1=1
        <if test="list!=null and list.size()>0">
            and a.id in
            <foreach item="ids" index="index" collection="list"
                     open="(" separator="," close=")">
                #{ids}
            </foreach>
        </if>
    </select>
</mapper>