<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tbl.modules.stock.dao.InventoryTaskDAO">
    <select id="getAllListT" resultType="com.tbl.modules.stock.entity.InventoryTask">
        select id,inventory_task_code,inventory_type,position_code,
        create_time,inventory_user_id,state,remark
        from inventory_task where 1=1
        <if test="list!=null and list.size()>0">
            and id in
            <foreach item="ids" index="index" collection="list"
                     open="(" separator="," close=")">
                #{ids}
            </foreach>
        </if>
    </select>

    <!--根据id更新状态-->
    <update id="updateState">
        update inventory_task set state = '1' where id=#{id}
    </update>

    <!--根据id更新状态-->
    <update id="updateInventoryTask">
        update inventory_task set state=3  where id=(select inventory_task_id from inventory_task_detail where id=#{id})
    </update>

    <select id="getMaxInventoryTaskCode" resultType="java.lang.String">
        select max(inventory_task_code) from inventory_task
    </select>

    <!--获取库位下拉列表-->
    <select id="getSelectPositionList" resultType="java.util.Map">
        select position_code as id ,inventory_time as text from inventory_task where position_code=#{positionCode}
        <if test='queryString!=null and queryString!=""'>
            and inventory_time like concat(concat('%', #{queryString}), '%')
        </if>
    </select>

    <!--获取库位ID-->
    <select id="selectBYCode" resultType="java.lang.Long">
        select id from base_depot_position where position_code=#{positionCode}
    </select>

    <!--获取库位下拉列表-->
    <select id="selectByPosition" resultType="java.lang.Long">
        select DISTINCT position_by  from stock_change
        where create_time Between #{creatTime} And #{endTime}
    </select>

    <!--获取盘点记录-->
    <select id="selectByInventory" resultType="com.tbl.modules.stock.entity.Inventory">
        select * from inventory where inventory_task_id=#{inventoryTaskId} and position_code=#{positionCode} and state="1" ORDER BY inventory_time DESC limit 1
    </select>

    <!--获取盘点记录详情 有rfid-->
    <select id="selectByRfidInventoryDetail" resultType="com.tbl.modules.stock.entity.InventoryDetail">
        select * from inventory_detail where batch_no=#{batchNo} and position_code=#{positionCode}
        and rfid like concat(concat('%', #{rfid}), '%') and material_code=#{materialCode} and state="2" ORDER BY complete_time DESC limit 1
    </select>

    <!--获取盘点记录详情  无rfid-->
    <select id="selectByInventoryDetail" resultType="com.tbl.modules.stock.entity.InventoryDetail">
        select * from inventory_detail where batch_no=#{batchNo} and position_code=#{positionCode}
        and rfid is null and material_code=#{materialCode} and state="2" ORDER BY complete_time DESC limit 1
    </select>


</mapper>