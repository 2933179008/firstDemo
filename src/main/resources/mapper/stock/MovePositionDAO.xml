<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tbl.modules.stock.dao.MovePositionDAO">

    <select id="getAllLists" resultType="com.tbl.modules.stock.entity.MovePosition">
        select id,move_position_code,rfid,move_user_id,former_position,position_by,move_found_time,move_position_time,
        complete_time,status,remarks
        from move_position
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="list!=null and list.size()>0">
                and id in
                <foreach item="ids" index="index" collection="list"
                         open="(" separator="," close=")">
                    #{ids}
                </foreach>
            </if>
            and delete_flag=1
        </trim>
    </select>

    <!--根据rfid查询绑定的物料-->
    <select id="getMaterialBundingDetail" resultType="java.util.Map">
        select a.*
        from materiel_bind_rfid_detail a
        inner join materiel_bind_rfid b on a.materiel_bind_rfid_by=b.id
        where b.rfid=#{rfid}
        and b.deleted_flag='1'
        and b.status='1'
    </select>

    <!--根据库位编号分组，获取库存表中该库位上的所有物料种类的物料重量和托盘库存数量-->
    <select id="getStockInfo" resultType="java.util.Map">
        select sum(stock_weight) as stock_weight_sum,sum(stock_rfid_amount) as stock_rfid_amount_sum
        from stock
        where position_code=#{positionCode}
        group by position_code
    </select>

    <!--根据物料编号和库位编号查询该库位中该物料的批次号-->
    <select id="getStockBatchNo" resultType="java.lang.String">
        select distinct batch_no
        from stock
        where material_code= #{materialCode}
        and position_code = #{positionCode}
    </select>

    <!--根据库位编号获取库存中库位的物料编号和批次号-->
    <select id="getStockMaterialCodeAndBatchNo" resultType="java.util.Map">
        select distinct material_code as materialCode,batch_no as batchNo
        from stock
        where position_code=#{positionCode}
    </select>

    <!--查询该rfid是否可用-->
    <select id="getSelectAvailableRfid" resultType="java.lang.Integer">
        select count(1)
        from stock
        where material_code=#{materialCode}
        and batch_no = #{batchNo}
        and position_code = #{formerpositionCode}
        and available_rfid like concat(concat('%', #{rfid}), '%')
    </select>

    <!--更新移库表的库位编码和其他字段-->
    <update id="updateMovePositionById">
        update move_position
        set position_by= #{positionId}
        where id = #{movePositionId}
    </update>

    <!--根据rfid获取绑定表id和绑定详情表id-->
    <select id="selectMaterialBundingByRfid" resultType="java.util.Map">
        select a.id as materielBindId,a.bind_code,b.id as materielBindDetailId,b.materiel_code,b.materiel_name,b.batch_rule,b.amount,b.weight
        from materiel_bind_rfid a
        inner join materiel_bind_rfid_detail b on a.id=b.materiel_bind_rfid_by
        where a.rfid=#{rfid}
        and b.delete_flag='1'
    </select>

    <!--根据移库表的id查询原库位主键id和库位编号-->
    <select id="selectFormerPosition" resultType="java.util.Map">
        select b.id,b.position_code,a.rfid
        from move_position a
        inner join base_depot_position b on a.former_position=b.id
        where a.id=#{movePositionId}
    </select>

    <!--减去原库位的库存-->
    <update id="updateStockFormerPosition">
        update stock
        set stock_amount=stock_amount-#{amount},
                available_stock_amount=available_stock_amount-#{amount},
                stock_weight=stock_weight-#{weight},
                available_stock_weight=available_stock_weight-#{weight},
                stock_rfid_amount=stock_rfid_amount-1,
                available_stock_rfid_amount=available_stock_rfid_amount-1,
                rfid=if(rfid like concat(#{rfid}, ',%'),REPLACE(rfid,concat(#{rfid}, ','),''),REPLACE(rfid,concat(',',#{rfid}),'')),
                available_rfid=if(available_rfid like concat(#{rfid}, ',%'),REPLACE(available_rfid,concat(#{rfid}, ','),''),REPLACE(available_rfid,concat(',',#{rfid}),''))
        where material_code=#{materialCode}
        and batch_no=#{batchNo}
        and position_code=#{formerPositionCode}
    </update>

    <!--根据物料编号、货物类型、批次号、库位编号查询库存中是否存在该条数据-->
    <select id="selectStockPositionCount" resultType="java.lang.Integer">
        select count(1)
        from stock
        where material_code=#{materialCode}
        and batch_no=#{batchNo}
        and position_code=#{positionCode}
        and material_type="1"
    </select>

    <!--插入现库位的库存-->
    <insert id="insertStockCurrentPosition">
        insert into stock(material_code,material_name,batch_no,position_code,position_name,stock_amount,available_stock_amount,stock_weight,available_stock_weight,stock_rfid_amount,available_stock_rfid_amount,rfid,available_rfid,create_time,create_by,update_time)
        values(#{materialCode},#{materialName},#{batchNo},#{positionCode},#{positionName},#{amount},#{amount},#{weight},#{weight},1,1,#{rfid},#{rfid},now(),#{userId},now())
    </insert>

    <!--更新绑定表库位id-->
    <update id="updateMaterialBundingPosition">
        update materiel_bind_rfid
        set position_by=#{positionId}
        where id=#{materielBindId}
    </update>

    <!--更新绑定详情表库位id-->
    <update id="updateMaterialBundingDetailPosition">
        <foreach collection="lstMaterielBindDetailId" item="materielBindDetailId" index="index" separator=";" open="" close="">
            update materiel_bind_rfid_detail
            set position_id=#{positionId}
            where id=#{materielBindDetailId}
        </foreach>
    </update>

    <!--更新现库位的库存-->
    <update id="updateStockCurrentPosition">
        update stock
        set stock_amount=stock_amount+#{amount},
                available_stock_amount=available_stock_amount+#{amount},
                stock_weight=stock_weight+#{weight},
                available_stock_weight=available_stock_weight+#{weight},
                stock_rfid_amount=stock_rfid_amount+1,
                available_stock_rfid_amount=available_stock_rfid_amount+1,
                rfid=if(rfid is null,#{rfid},CONCAT(rfid,',',#{rfid})),
                available_rfid=if(available_rfid is null,#{rfid},CONCAT(available_rfid,',',#{rfid}))
        where material_code=#{materialCode}
        and batch_no=#{batchNo}
        and position_code=#{positionCode}
    </update>

    <!--获取库存列表数据-->
    <select id="selectByListS" resultType="com.tbl.modules.stock.entity.Stock">
        SELECT a.material_code AS materielCode, a.material_name AS materielName,a.batch_no AS batchRule,b.unit,
        c.move_position_amount AS amount,c.move_position_weight AS weight,a.rfid from stock a
        INNER JOIN base_materiel b ON a.material_code=b.materiel_code
        INNER JOIN move_position c ON a.material_code=c.materiel_code and c.delete_flag="1" and a.batch_no=c.batch_no
        where a.material_code=#{materielCode}
        and a.batch_no=#{batchNo}
        and a.position_code=#{positionCode}
        and a.material_type="0"
    </select>
</mapper>