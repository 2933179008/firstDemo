<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tbl.modules.stock.dao.StockDAO">
    <!--更新库存表相关信息-->
    <update id="updateStockById">
        update stock
        set stock_amount=stock_amount+#{putAmount},
            stock_weight=stock_weight+#{putWeight},
            stock_rfid_amount=stock_rfid_amount+1,
            rfid=CONCAT(rfid,',',#{rfid}),
            update_time=now()
        where id=#{id}
    </update>

    <!--获取库存列表数据-->
    <select id="selectByList" resultType="com.tbl.modules.stock.entity.Stock">
       SELECT a.id,a.position_code AS positionCode,a.position_name AS positionName,a.material_code AS materialCode,a.material_name AS materialName,
       a.material_type AS materialType,a.batch_no AS batchNo,sum(a.stock_amount) AS stockAmount,sum(a.available_stock_amount) AS availableStockAmount,sum(a.stock_weight) AS stockWeight,
       sum(a.available_stock_weight) AS availableStockWeight,a.product_date AS productDate,a.quality_date AS qualityDate,a.customer_code AS customerCode   from stock a
--        INNER JOIN base_depot_position b ON a.position_code=b.position_code

        /*物料编号*/
        <if test="materialCode != null and materialCode.trim() != ''">
            and a.material_code like concat(concat('%', #{materialCode}), '%')
        </if>

        /*物料名称*/
        <if test="materialName != null and materialName.trim() != ''">
            and a.material_name like concat(concat('%', #{materialName}), '%')
        </if>

        /*批次号*/
        <if test="batchNo != null and batchNo.trim() != ''">
            and a.batch_no like concat(concat('%', #{batchNo}), '%')
        </if>

        /*库位编码*/
        <if test="positionCode != null and positionCode.trim() != ''">
            and a.position_code like concat(concat('%', #{positionCode}), '%')
        </if>

        /*生产日期*/
        <if test="productDate != null and productDate.trim() != ''">
            and a.product_date like concat(concat('%', #{productDate}), '%')
        </if>

        /*货物类型*/
        <if test="materialType != null and materialType.trim() != ''">
            and a.material_type like concat(concat('%', #{materialType}), '%')
        </if>

        /*保质期至*/
        <if test="qualityDate != null and qualityDate.trim() != ''">
            and a.quality_date like concat(concat('%', #{qualityDate}), '%')
        </if>

        /*货主*/
        <if test="customerCode != null and customerCode.trim() != ''">
            and a.customer_code like concat(concat('%', #{customerCode}), '%')
        </if>

        GROUP BY a.material_code,a.batch_no,a.material_type,a.position_code

    </select>

    <!--获取保质期为空的库存数据-->
    <select id="selectByListQuality" resultType="com.tbl.modules.stock.entity.Stock">
        SELECT * from stock where product_date is not null and quality_date is null
    </select>


    <!--获取盘点详情列表数据-->
    <select id="selectListS" resultType="com.tbl.modules.stock.entity.Stock">
        SELECT a.id,a.material_code,a.material_name,a.batch_no,a.position_name,a.stock_amount, c.rfid AS rfid
        FROM stock a
        INNER JOIN stock_bind_relation b ON a.id=b.stock_id
        INNER JOIN materiel_bind_rfid c ON c.id=b.material_bind_rfid_id
        WHERE a.id =#{stockId}


        /*物料编号*/
        <if test="materialCode != null and materialCode.trim() != ''">
            and a.material_code like concat(concat('%', #{materialCode}), '%')
        </if>

        /*物料名称*/
        <if test="materialName != null and materialName.trim() != ''">
            and a.material_name like concat(concat('%', #{materialName}), '%')
        </if>

    </select>

    <select id="getSelectPositionList" resultType="com.tbl.modules.stock.entity.Stock">
        select position_code, position_name as text from stock
        <if test="queryString!=null and queryString!=''">
            and position_name like concat(concat('%', #{queryString}), '%')
        </if>

    </select>

    <select id="uniqeList" resultType="com.tbl.modules.stock.entity.Stock">
        select distinct position_code,position_name from stock where 1=1
        <if test="list!=null and list.size()>0">
            and position_code in
            <foreach item="lstPositionCodes" index="index" collection="list"
                     open="(" separator="," close=")">
                #{lstPositionCodes}
            </foreach>
        </if>
    </select>


</mapper>